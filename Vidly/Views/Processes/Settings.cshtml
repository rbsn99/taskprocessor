
@{
    ViewBag.Title = "Settings";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Settings</h2>
 

<div id="process" class="container">
    <ul class="nav nav-tabs">
        <li class="active">
            <a href="#details" data-toggle="tab">Process details & metadata</a>
        </li>
        <li>
            <a href="#flow" data-toggle="tab">Tasks</a>
        </li>
        <li>
            <a href="#flow" data-toggle="tab">Flow diagram</a>
        </li>
    </ul>

    <div class="tab-content ">
        <div class="tab-pane active" id="details">
 
            <form class="well form-horizontal"   method="post" id="process_details_form">
                <fieldset>

                    <!-- Form Name -->
                    <legend>Process details</legend>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label">Process ID</label>
                        <div class="col-md-4 inputGroupContainer">
                            <input id="process_id" placeholder="Process ID" class="form-control" type="text" readonly>
                        </div>
                    </div>
                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label">Process GUID</label>
                        <div class="col-md-4 inputGroupContainer">
                            <input id="process_guid" placeholder="Process GUID" class="form-control" type="text" readonly>
                        </div>
                    </div>
                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label">Process Name</label>
                        <div class="col-md-4 inputGroupContainer">                            
                             <input id="process_name" placeholder="Process Name" class="form-control" type="text">                      
                        </div>
                    </div>
                    
                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label">Created date</label>
                        <div class="col-md-4 inputGroupContainer">
                            <input id="created_date" placeholder="Created date" class="form-control" type="text" readonly="">
                        </div>
                    </div>

                    <!-- Button -->
                    <div class="form-group">
                        <label class="col-md-4 control-label"></label>
                        <div class="col-md-4">
                            <button type="submit" class="btn" onclick="UpdateProcessDetails();">Save</button>
                        </div>
                    </div>

                </fieldset>
            </form>

        </div>
        <!--Flow tab-->
        <div class="tab-pane" id="flow">
            <h3>Process flow</h3>
            <div id="taskTypes">
                <select id="typeSelect">
                    <!--generated by JS on load-->
                </select>
                <button class="btn" onclick="AddNewTask();">Add new task</button>
                <table id="tasks" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>GUID</th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Task type</th>
                            <th>Attributes</th>
                            <th>Recipients</th>
                            <th>Dependencies</th>
                            <th>Update</th>
 
                    </thead>
                    <tbody>
 
                    </tbody>
                </table>
                <button class="btn" id="updateSettingsBtn" onclick="UpdateTaskSettings();">Update settings</button>
            </div> 
        </div>


 
    </div>
</div>
 
 
 @section scripts
 {
     <script>
         $(document).ready(function () {
             var currenturl = window.location.pathname;
             var id = currenturl.substring(currenturl.lastIndexOf('/') + 1);

             LoadProcessDetails(id);
             LoadProcessTasksTypes();
             LoadProcessTasks(id);
             }
         );

         function LoadProcessTasks(id) {
             var num = 0;
             var table = $("#tasks").DataTable({
                 destroy: true,

                 ajax: {
                     url: "processtasks/" + id,
                     dataSrc: ""
                 },
                 columns: [
                     {
                         data: "ProcessTaskGuid",
                         render: function (data, type, processtask)
                         { return "<input class=\"ProcessTaskGuid\" type=\"text\" value=\" " + processtask.ProcessTaskGuid + " \" readonly disabled>" }
                     },
                     {
                         data: "Id",
                         render: function (data, type, processtask)
                         //render: function()
                         { num++; return "<input class=\"Id\" type=\"text\" value=\" " + processtask.Id + " \" readonly disabled>" }

                     },
                     {
                         data: "TaskName",
                         render: function (data, type, processtask)
                         { return "<input class=\"TaskName\" type=\"text\" value=\"" + processtask.TaskName + "\" >" }

                     },
                     {
                         data: "ProcessTaskType.ProcessTaskTypeName",
                         render: function (data, type, processtask)
                         { return "<input class=\"ProcessTaskTypeName\" type=\"text\" value=\" " + processtask.ProcessTaskType.ProcessTaskTypeName + " \" readonly disabled>" }

                     },
                     {
                         data: "attributes",
                         render: function (data, type, processtask) {
                             var fullAttributeValuesList = "";
                             for (i = 0 ; i < processtask.ProcessTaskAttributes.length ; i++)
                             {
                                 fullAttributeValuesList += processtask.ProcessTaskAttributes[i].AttributeKey;
                                 fullAttributeValuesList += "=";
                                 fullAttributeValuesList += processtask.ProcessTaskAttributes[i].AttributeValue;
                                 fullAttributeValuesList += ";";

                             }
                             return "<textarea class =\"attributes\">" + fullAttributeValuesList + "</textarea>";
                         }

                     },
                     {
                         render: function (data, type, processtask)
                         { return "<input class=\"recipHolder\" type=\"text\" value=\" " + "recipHolder" + " \" >" }
                     },
                     {
                         render: function (data, type, processtask)
                         { return "<input class=\"depHolder\" type=\"text\" value=\" " + processtask.ProcessTaskDependencies + " \" >" }
                     },
                     {
                         render: function (data, type, processtask)
                         {
                             return "<button type=\"button\" class=\"btn\" onclick=\"UpdateTaskSettings('"
                               + processtask.ProcessTaskGuid + "');\" id=\""
                               + processtask.ProcessTaskGuid + "\"> Update </button>"
                         }
                     }
                 ]
             });
         }

         function LoadProcessDetails(id)
         {

             $.getJSON('/api/processes/settings/' + id,
                 function (data) {
                     document.getElementById("process_id").value = data.Id;
                     document.getElementById("process_name").value = data.ProcessName;
                     document.getElementById("process_guid").value = data.ProcessGuid;
                     document.getElementById("created_date").value = data.CreatedDate;
                 });
         }

         function LoadProcessTasksTypes() {
             //alert('test');
             $.getJSON('/api/processes/tasktypes',
                     function (data) {
                         for (i = 0; i < data.length; i++) {
                             // $('#taskTypes ul').append('<li><a href="#" data-id="' + data[i].Id + '">' + data[i].ProcessTaskTypeName + '</a></li>');
                             $('#taskTypes select').append('<option value =' + data[i].Id + '>' + data[i].ProcessTaskTypeName + '</option>');
                         }
                     });
         }

         function UpdateProcessDetails() {
             $(function () {
                 var id = document.getElementById("process_id").value;
                 var process = { ProcessName: document.getElementById("process_name").value};
                 $.ajax({
                     type: "PUT",
                     data: JSON.stringify(process),
                     url: "/api/processes/settings/" + id,
                     contentType: "application/json"
                 });
             });
         }
 
         
         function UpdateTaskSettings(processTaskGuid) {
 
             var id;
             
             
             $("#tasks tr").each(function () {
                    var _ProcessTaskGuid=  $(this).find("input.ProcessTaskGuid").val(),
                    _Id =                  $(this).find("input.Id").val(),
                    _TaskName =            $(this).find("input.TaskName").val(),
                    _ProcessTaskTypeName = $(this).find("input.ProcessTaskTypeName").val(),
                    _attributes =          $(this).find("textarea.attributes").val(),
                    _recipHolder =         $(this).find("input.recipHolder").val(),
                    _depHolder =           $(this).find("input.depHolder").val();
                                        
                    id = document.getElementById("process_id").value;

                    var ptu = {
                        Id : _Id,
                        ProcessTaskGuid : _ProcessTaskGuid,
                        TaskName: _TaskName,
                        ProcessTaskAttributes: _attributes,
                        ProcessTaskRecipient: _recipHolder,
                        ProcessTaskDependencies: _depHolder,
                        ProcessId: id
                    };

                   
                     if(ptu.ProcessTaskGuid != null)   
                        if (processTaskGuid == ptu.ProcessTaskGuid.trim()) {
                            $.ajax({
                                type: "PUT",
                                data: JSON.stringify(ptu),
                                url: "processtasks/" + id,
                                contentType: "application/json"
                            });
                        }
                 });
          
             alert('Task updated!');
 
             LoadProcessTasks(id);
         }


         function AddNewTask()
         {
             var selectElement = document.getElementById("typeSelect");
             var taskType = selectElement.options[selectElement.selectedIndex].value;

             processId = document.getElementById("process_id").value;
            
             var pt = {
                 TaskTypeId: taskType,
                 ProcessId: processId
             };
             $.ajax({
                 type: "POST",
                 data: JSON.stringify(pt),
                 url: "processtasks/newtask/",
                 contentType: "application/json"
             });
             
             alert('Task added!');
             id = document.getElementById("process_id").value;
             LoadProcessTasks(id);
         }
     </script>
 }
